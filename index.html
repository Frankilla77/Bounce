<html>
<head>
</head>
<body>

Hello World!</br>
<p>We are using node <script>document.write(process.versions.node)</script>,
Chrome <script>document.write(process.versions.chrome)</script>,
and Electron <script>document.write(process.versions.electron)</script>.</p>

<select id="ports">
</select><br>
<button id="ledon">LED ON</button>
<button id="ledoff">LED OFF</button>
<br>
<div id="serial_log"></div>
<script>
    const SerialPort = require("serialport");
    const jquery = require("jquery");
    const Blockly = require("node-blockly/lua");

    var current_port = null;

    function connect_port(comName) {
        if(comName) {
            console.log("Connecting: " + comName);
            current_port = new SerialPort.SerialPort(comName);

            current_port.on('error', function(err) {
                console.log('Error: ', err.message);
            });  
        } else {
            console.log("Disconnecting");
            current_port = null;
        }
    }

    function setup_serial_ui() {
        var ports_ui = jquery("#ports");
        var element = jquery('<option> --- </option>').attr({title: 'Disconnected', value: null});
        ports_ui.append(element);
        ports_ui.change(function() {connect_port(ports_ui.val());});

        jquery('#ledon').click(function() {
          console.log("Sending LED on...\n");
          current_port.write("LED ON\n", function(err) {
              console.log("LED should be on\n");
          });
        });

        
        jquery('#ledoff').click(function() {
          console.log("Sending LED off...\n");
          current_port.write("LED OFF\n", function(err) {
              console.log("LED should be on\n");
          });
        });


        SerialPort.list(function(err, ports) {
            ports.forEach(function(port) {
                // Create element representing this port
                var element = jquery('<option>' + port.comName + '</option>').attr({title: port.manufacturer, value: port.comName});
                // Add it to the ports selection.
                ports_ui.append(element);                
            });
        });
    }

    function setup_blockly() {
        var xmlText = `<xml xmlns="http://www.w3.org/1999/xhtml">
            <block type="variables_set">
                <field name="VAR">blockly</field>
                <value name="VALUE">
                    <block type="text">
                        <field name="TEXT">Hello Node.js!</field>
                    </block>
                </value>
            </block>
        </xml>`;

        try {
            var xml = Blockly.Xml.textToDom(xmlText);
        }
        catch (e) {
            console.log(e);
            return
        }

        var workspace = new Blockly.Workspace();
        Blockly.Xml.domToWorkspace(xml, workspace);
        var code = Blockly.Lua.workspaceToCode(workspace);

        console.log(code);

    }

    jquery(function() {
        setup_serial_ui();
        setup_blockly();
    });
</script>
</body>
</html>